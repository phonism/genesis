<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A lightweight deep learning framework built from scratch with Python + Triton + CUDA"><meta name=author content="Genesis Team"><link href=https://phonism.github.io/genesis/zh/memory-allocator-optimization/ rel=canonical><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.16"><title>Genesis GPU内存分配器性能优化实战 - Genesis Deep Learning Framework</title><link rel=stylesheet href=../../assets/stylesheets/main.7e37652d.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../../stylesheets/extra.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function e(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],e("js",new Date),e("config",""),document.addEventListener("DOMContentLoaded",(function(){document.forms.search&&document.forms.search.query.addEventListener("blur",(function(){this.value&&e("event","search",{search_term:this.value})}));document$.subscribe((function(){var t=document.forms.feedback;if(void 0!==t)for(var a of t.querySelectorAll("[type=submit]"))a.addEventListener("click",(function(a){a.preventDefault();var n=document.location.pathname,d=this.getAttribute("data-md-value");e("event","feedback",{page:n,data:d}),t.firstElementChild.disabled=!0;var r=t.querySelector(".md-feedback__note [data-md-value='"+d+"']");r&&(r.hidden=!1)})),t.hidden=!1})),location$.subscribe((function(t){e("config","",{page_path:t.pathname})}))}));var t=document.createElement("script");t.async=!0,t.src="https://www.googletagmanager.com/gtag/js?id=",document.getElementById("__analytics").insertAdjacentElement("afterEnd",t)}</script><script>if("undefined"!=typeof __md_analytics){var consent=__md_get("__consent");consent&&consent.analytics&&__md_analytics()}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#genesis-gpu class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <div data-md-color-scheme=default data-md-component=outdated hidden> </div> <header class="md-header md-header--shadow md-header--lifted" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Genesis Deep Learning Framework" class="md-header__button md-logo" aria-label="Genesis Deep Learning Framework" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Genesis Deep Learning Framework </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Genesis GPU内存分配器性能优化实战 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media=(prefers-color-scheme) data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to system preference" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to system preference" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/phonism/genesis title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> genesis </div> </a> </div> </nav> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../../getting-started/ class=md-tabs__link> Getting Started </a> </li> <li class=md-tabs__item> <a href=../../tutorials/ class=md-tabs__link> Tutorials </a> </li> <li class=md-tabs__item> <a href=../../core-components/ class=md-tabs__link> Core Components </a> </li> <li class=md-tabs__item> <a href=../../architecture/ class=md-tabs__link> Architecture </a> </li> <li class=md-tabs__item> <a href=../../models/qwen/ class=md-tabs__link> Models </a> </li> <li class=md-tabs__item> <a href=../../api-reference/ class=md-tabs__link> API Reference </a> </li> <li class=md-tabs__item> <a href=../../contributing/ class=md-tabs__link> Contributing </a> </li> </ul> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Genesis Deep Learning Framework" class="md-nav__button md-logo" aria-label="Genesis Deep Learning Framework" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> Genesis Deep Learning Framework </label> <div class=md-nav__source> <a href=https://github.com/phonism/genesis title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> genesis </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../getting-started/ class=md-nav__link> <span class=md-ellipsis> Getting Started </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../tutorials/ class=md-nav__link> <span class=md-ellipsis> Tutorials </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../core-components/ class=md-nav__link> <span class=md-ellipsis> Core Components </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../architecture/ class=md-nav__link> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../models/qwen/ class=md-nav__link> <span class=md-ellipsis> Models </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../api-reference/ class=md-nav__link> <span class=md-ellipsis> API Reference </span> <span class="md-nav__icon md-icon"></span> </a> </li> <li class="md-nav__item md-nav__item--pruned md-nav__item--nested"> <a href=../../contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> <span class="md-nav__icon md-icon"></span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/phonism/genesis/edit/main/docs/zh/memory-allocator-optimization.md title="Edit this page" class="md-content__button md-icon" rel=edit> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <a href=https://github.com/phonism/genesis/raw/main/docs/zh/memory-allocator-optimization.md title="View source of this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg> </a> <h1 id=genesis-gpu>Genesis GPU内存分配器性能优化实战<a class=headerlink href=#genesis-gpu title="Permanent link">&para;</a></h1> <blockquote> <p>记录Genesis深度学习框架GPU内存分配器的性能优化过程，从发现问题到逐步解决的完整技术博客</p> </blockquote> <h2 id=genesis>背景：为什么Genesis内存分配这么慢？<a class=headerlink href=#genesis title="Permanent link">&para;</a></h2> <p>在使用我们自研的Genesis深度学习框架时，发现了一个严重的性能问题：GPU内存分配比PyTorch慢很多。通过对比测试发现：</p> <div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>CUDAStorage allocation vs PyTorch:
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>- 1K elements:   Genesis 0.58x PyTorch (慢42%)
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>- 10K elements:  Genesis 0.75x PyTorch (慢25%) 
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>- 100K elements: Genesis 0.42x PyTorch (慢58%)
</span></code></pre></div> <p>更让人震惊的是<code>fill_</code>操作的性能：</p> <div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>Fill operation (before optimization):
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>- 512×512:   Genesis 0.10x PyTorch (慢10倍!)
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>- 1024×1024: Genesis 0.03x PyTorch (慢33倍!)
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>- 2048×2048: Genesis 0.01x PyTorch (慢100倍!)
</span></code></pre></div> <p>这显然不能接受。我们需要深入分析问题并制定优化方案。</p> <h2 id=_1>第一步：建立性能基线测试<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>任何优化都要先建立准确的基线测试。我们需要了解： 1. 当前的分配性能到底有多慢？ 2. 哪些分配模式是性能瓶颈？ 3. 与PyTorch的具体差距在哪里？</p> <h3 id=_2>设计基准测试<a class=headerlink href=#_2 title="Permanent link">&para;</a></h3> <p>我创建了专门的内存管理器基准测试工具 <code>benchmark/bench_memory_manager.py</code>，测试以下关键模式：</p> <ol> <li><strong>同尺寸重复分配</strong> - 模拟训练循环</li> <li><strong>分配-释放循环</strong> - 测试内存复用能力 </li> <li><strong>变化尺寸分配</strong> - 模拟批次大小变化</li> <li><strong>大内存分配</strong> - 测试大块内存行为</li> <li><strong>PyTorch缓存分析</strong> - 深入了解PyTorch的缓存机制</li> </ol> <h3 id=_3>基线测试结果<a class=headerlink href=#_3 title="Permanent link">&para;</a></h3> <p>运行测试后，结果令人震惊：</p> <div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>🔴 整体性能统计：
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>- 平均加速比: 0.16x (Genesis比PyTorch慢6倍!)
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>- 最差加速比: 0.02x (分配-释放循环慢50倍!)
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>- 最佳加速比: 0.38x (仍然慢2.6倍)
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>📊 按模式分类：
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>- 同尺寸重复分配:    0.22x (较差)
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>- 分配-释放循环:     0.02x (严重!)  
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>- 变化尺寸分配:      0.12x (严重)
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>- 大内存分配:        0.20x (较差)
</span></code></pre></div> <h3 id=_4>关键发现<a class=headerlink href=#_4 title="Permanent link">&para;</a></h3> <h4 id=1-pytorch>1. <strong>PyTorch缓存效果惊人</strong><a class=headerlink href=#1-pytorch title="Permanent link">&para;</a></h4> <div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>PyTorch 1024×1024 分配行为：
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>- 首次分配(冷启动): 0.458ms
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>- 二次分配(缓存命中): 0.021ms  
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>- 缓存加速比: 22倍!
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>连续10次分配：
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>- PyTorch平均: 0.015ms 
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>- Genesis平均: 0.925ms
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>- 稳态性能差距: 62倍!
</span></code></pre></div> <h4 id=2-genesis>2. <strong>Genesis没有任何缓存</strong><a class=headerlink href=#2-genesis title="Permanent link">&para;</a></h4> <p>Genesis每次分配时间基本一致（0.9-1.0ms），说明确实是每次都在调用 <code>cudaMalloc</code>，完全没有缓存机制。</p> <h4 id=3->3. <strong>分配-释放循环是最大瓶颈</strong><a class=headerlink href=#3- title="Permanent link">&para;</a></h4> <div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>分配-释放循环性能（20次循环）：
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>- 1024×1024: PyTorch 0.149ms vs Genesis 5.116ms (慢34倍!)
</span></code></pre></div> <p>这证实了专家分析：<code>cudaFree</code> 的隐式同步严重影响性能。</p> <h3 id=_5>优化方向确定<a class=headerlink href=#_5 title="Permanent link">&para;</a></h3> <p>基于测试结果，我们的优化优先级非常明确：</p> <ol> <li><strong>🔴 紧急</strong>: 实现基本缓存池，解决重复 <code>cudaMalloc/cudaFree</code> 问题</li> <li><strong>🟠 重要</strong>: 优化内存复用策略，特别是分配-释放循环</li> <li><strong>🟡 改进</strong>: 处理变化尺寸的分配模式</li> </ol> <p>现在让我们开始第一阶段优化。</p> <h2 id=_6>第二步：实现简单缓存池<a class=headerlink href=#_6 title="Permanent link">&para;</a></h2> <p>基于基线测试的发现，我们首先实现一个简单的内存缓存池来避免频繁的 <code>cudaMalloc/cudaFree</code> 调用。</p> <h3 id=phase-1>Phase 1设计方案<a class=headerlink href=#phase-1 title="Permanent link">&para;</a></h3> <p>我实现了一个最小可用缓存分配器，具有以下特性：</p> <ol> <li><strong>512B对齐</strong>: 所有分配都对齐到512字节边界</li> <li><strong>精确尺寸匹配</strong>: 按确切大小缓存，避免内存浪费</li> <li><strong>简单自由链</strong>: 使用 <code>defaultdict(list)</code> 实现 size -&gt; [ptr_list] 映射</li> <li><strong>即时回收</strong>: 释放时立即放回缓存（如果缓存未满）</li> <li><strong>单流友好</strong>: 当前版本不处理跨流，专注验证缓存效果</li> </ol> <h3 id=_7>核心实现<a class=headerlink href=#_7 title="Permanent link">&para;</a></h3> <div class="language-python highlight"><span class=filename>Python</span><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=k>class</span><span class=w> </span><span class=nc>CUDAMemoryManager</span><span class=p>:</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>        <span class=c1># Phase 1: Simple caching allocator</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>        <span class=bp>self</span><span class=o>.</span><span class=n>free_blocks</span> <span class=o>=</span> <span class=n>defaultdict</span><span class=p>(</span><span class=nb>list</span><span class=p>)</span>  <span class=c1># size -&gt; [ptr_list] </span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>        <span class=bp>self</span><span class=o>.</span><span class=n>active_blocks</span> <span class=o>=</span> <span class=p>{}</span>  <span class=c1># ptr -&gt; size</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>        <span class=bp>self</span><span class=o>.</span><span class=n>alignment</span> <span class=o>=</span> <span class=mi>512</span>  <span class=c1># 512B alignment</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>        <span class=bp>self</span><span class=o>.</span><span class=n>max_cache_size</span> <span class=o>=</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span> <span class=o>*</span> <span class=mi>1024</span>  <span class=c1># 1GB cache limit</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>    <span class=k>def</span><span class=w> </span><span class=nf>allocate</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>nbytes</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>stream</span><span class=o>=</span><span class=kc>None</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>        <span class=n>aligned_size</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_round_up</span><span class=p>(</span><span class=n>nbytes</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>alignment</span><span class=p>)</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>        <span class=c1># Try cache first</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>free_blocks</span><span class=p>[</span><span class=n>aligned_size</span><span class=p>]:</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>            <span class=n>ptr</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>free_blocks</span><span class=p>[</span><span class=n>aligned_size</span><span class=p>]</span><span class=o>.</span><span class=n>pop</span><span class=p>()</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a>            <span class=bp>self</span><span class=o>.</span><span class=n>cache_hits</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>            <span class=k>return</span> <span class=n>ptr</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>        <span class=c1># Cache miss - allocate from CUDA</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>        <span class=n>ptr</span> <span class=o>=</span> <span class=n>cuda</span><span class=o>.</span><span class=n>cuMemAlloc</span><span class=p>(</span><span class=n>aligned_size</span><span class=p>)</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a>        <span class=bp>self</span><span class=o>.</span><span class=n>cache_misses</span> <span class=o>+=</span> <span class=mi>1</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a>        <span class=k>return</span> <span class=n>ptr</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a>    <span class=k>def</span><span class=w> </span><span class=nf>free</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>ptr</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>stream</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a>        <span class=n>size</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>active_blocks</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=n>ptr</span><span class=p>)</span>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a>        <span class=c1># Return to cache if not full</span>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>current_cache_size</span> <span class=o>+</span> <span class=n>size</span> <span class=o>&lt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_cache_size</span><span class=p>:</span>
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a>            <span class=bp>self</span><span class=o>.</span><span class=n>free_blocks</span><span class=p>[</span><span class=n>size</span><span class=p>]</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>ptr</span><span class=p>)</span>
</span><span id=__span-5-29><a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a>            <span class=k>return</span>
</span><span id=__span-5-30><a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a>
</span><span id=__span-5-31><a id=__codelineno-5-31 name=__codelineno-5-31 href=#__codelineno-5-31></a>        <span class=c1># Cache full - actually free</span>
</span><span id=__span-5-32><a id=__codelineno-5-32 name=__codelineno-5-32 href=#__codelineno-5-32></a>        <span class=n>cuda</span><span class=o>.</span><span class=n>cuMemFree</span><span class=p>(</span><span class=n>ptr</span><span class=p>)</span>
</span></code></pre></div> <h3 id=phase-1_1>Phase 1优化结果<a class=headerlink href=#phase-1_1 title="Permanent link">&para;</a></h3> <p>简单缓存分配器的基准测试结果：</p> <h4 id=_8><strong>性能表现</strong><a class=headerlink href=#_8 title="Permanent link">&para;</a></h4> <div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>平均加速比: 0.98x
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>中位数加速比: 0.65x  
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>性能范围: 0.03x ~ 2.85x
</span></code></pre></div> <h4 id=_9><strong>分场景分析</strong><a class=headerlink href=#_9 title="Permanent link">&para;</a></h4> <p><strong>表现良好的场景:</strong> - 同尺寸重复分配: 1.43x - 大内存分配: 1.29x<br> - 推理动态批次: 1.01x</p> <p><strong>表现一般的场景:</strong> - 分配-释放循环: 0.84x - 变化尺寸分配: 0.51x</p> <p><strong>表现较差的场景:</strong> - Transformer训练: 0.04x - 梯度累积: 0.03x - 内存压力: 0.08x</p> <h4 id=_10><strong>主要发现</strong><a class=headerlink href=#_10 title="Permanent link">&para;</a></h4> <p><strong>缓存机制验证:</strong> - 精确尺寸匹配在重复分配场景下有效 - 大分配(≥100K元素)平均达到1.20x - 小分配(&lt;100K元素)仅0.46x，成为性能瓶颈</p> <p><strong>局限性:</strong> - 复杂场景下缓存命中率低 - 精确匹配策略不适合多样化内存模式 - 需要更灵活的缓存策略</p> <h2 id=_11>第二步：下一阶段优化计划<a class=headerlink href=#_11 title="Permanent link">&para;</a></h2> <p>基于Phase 1的结果分析，确定优化优先级：</p> <h3 id=_12><strong>核心问题诊断</strong><a class=headerlink href=#_12 title="Permanent link">&para;</a></h3> <ol> <li><strong>小分配性能差</strong>: &lt;100K元素场景拖累整体性能</li> <li><strong>复杂场景失效</strong>: 多样化内存模式下缓存命中率极低</li> <li><strong>精确匹配局限</strong>: 当前策略不适合尺寸变化大的场景</li> </ol> <h3 id=phase-2><strong>Phase 2优化方案: 尺寸桶缓存</strong><a class=headerlink href=#phase-2 title="Permanent link">&para;</a></h3> <p><strong>目标</strong>: 提高缓存命中率，解决变化尺寸分配问题</p> <p><strong>核心改进</strong>: - 将精确匹配改为桶匹配 (如64B, 128B, 256B, 512B...) - 减少内存碎片，提高复用率 - 优先解决小分配性能问题</p> <p><strong>预期效果</strong>: - 变化尺寸分配从0.51x提升到0.8x+ - 复杂场景性能改善 - 整体平均性能从0.98x提升到1.2x+</p> <h3 id=_13><strong>实施计划</strong><a class=headerlink href=#_13 title="Permanent link">&para;</a></h3> <ol> <li>设计桶大小策略 (2的幂次 vs 固定步长)</li> <li>实现桶匹配分配逻辑</li> <li>基准测试验证效果</li> <li>根据结果决定是否进入Phase 3 (块分配器)</li> </ol> <p>当前Phase 1已建立稳定基础，可以开始Phase 2开发。</p> <h2 id=phase-2_1>Phase 2实施：尺寸桶缓存优化<a class=headerlink href=#phase-2_1 title="Permanent link">&para;</a></h2> <h3 id=_14><strong>核心改进</strong><a class=headerlink href=#_14 title="Permanent link">&para;</a></h3> <p>将精确尺寸匹配改为桶匹配策略： - 使用2的幂次桶: 512B, 1KB, 2KB, 4KB... - 最大桶限制16MB，超出使用精确对齐 - 提高变化尺寸场景的缓存命中率</p> <h3 id=_15><strong>实施结果</strong><a class=headerlink href=#_15 title="Permanent link">&para;</a></h3> <h4 id=_16><strong>整体性能对比</strong><a class=headerlink href=#_16 title="Permanent link">&para;</a></h4> <div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>Phase 1 → Phase 2:
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>平均加速比: 0.98x → 0.97x (略微下降)
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>中位数加速比: 0.65x → 0.88x (显著提升 +35%)
</span></code></pre></div> <h4 id=_17><strong>分场景性能变化</strong><a class=headerlink href=#_17 title="Permanent link">&para;</a></h4> <p><strong>显著改善的场景:</strong> - 变化尺寸分配: 0.51x → 0.83x (+63%) - 内存压力: 0.08x → 1.48x (+1750%)<br> - 推理动态批次: 1.01x → 1.40x (+39%) - 分配-释放循环: 0.84x → 1.01x (+20%)</p> <p><strong>性能下降的场景:</strong> - 同尺寸重复分配: 1.43x → 0.90x (-37%)</p> <p><strong>依然严重的瓶颈:</strong> - Transformer训练: 0.04x → 0.05x (几乎无改善) - 梯度累积: 0.03x → 0.07x (微小改善)</p> <h3 id=phase-2_2><strong>Phase 2技术评估</strong><a class=headerlink href=#phase-2_2 title="Permanent link">&para;</a></h3> <p><strong>成功验证:</strong> - 桶匹配有效提高了变化尺寸场景的缓存命中率 - 中位数性能的大幅提升说明大部分场景受益 - 内存压力场景的突破证明了桶缓存的价值</p> <p><strong>发现的问题:</strong> - 桶缓存引入了内存浪费，影响了同尺寸分配的性能 - 复杂训练场景(Transformer/梯度累积)仍未得到根本改善 - 需要更深层的优化策略来解决核心瓶颈</p> <h3 id=transformer><strong>Transformer场景瓶颈根因分析</strong><a class=headerlink href=#transformer title="Permanent link">&para;</a></h3> <p>通过深入分析发现，桶缓存对复杂训练场景无效的根本原因：</p> <h4 id=_18><strong>大张量超出桶限制</strong><a class=headerlink href=#_18 title="Permanent link">&para;</a></h4> <ul> <li>Logits张量达到78MB-313MB，远超16MB桶限制</li> <li>超大张量回退到精确对齐，无法享受桶缓存优势</li> <li>频繁的大内存cudaMalloc调用成为主要开销</li> </ul> <h4 id=_19><strong>架构层面的差异</strong><a class=headerlink href=#_19 title="Permanent link">&para;</a></h4> <div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>PyTorch块分配器优势:
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>- 预分配大内存池(512MB-2GB)
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>- 从内存池切分张量，避免cudaMalloc
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>- 释放时回收到池中，实现真正的零开销复用
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>Genesis桶缓存局限:
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>- 每个张量仍需独立的cudaMalloc
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>- 无法利用内存池的根本优势
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>- 大张量完全绕过缓存机制
</span></code></pre></div> <h4 id=_20><strong>性能瓶颈的真相</strong><a class=headerlink href=#_20 title="Permanent link">&para;</a></h4> <ul> <li>60个张量，大部分4MB-320MB级别</li> <li>cudaMalloc对大内存块的系统调用开销巨大</li> <li>缓存命中率再高也无法掩盖根本的架构问题</li> </ul> <p><strong>结论</strong>: 桶缓存是渐进式改进，但无法解决大规模训练的根本问题。需要实现PyTorch风格的块分配器(Block Allocator)才能真正突破性能瓶颈。</p> <h2 id=phase-3block-allocator>Phase 3实施：Block Allocator块分配器<a class=headerlink href=#phase-3block-allocator title="Permanent link">&para;</a></h2> <h3 id=_21><strong>核心设计</strong><a class=headerlink href=#_21 title="Permanent link">&para;</a></h3> <p>实现PyTorch风格的块分配器，解决大内存分配的根本性能问题： - 预分配大内存段(1GB)作为内存池 - 使用best-fit算法从池中切分块 - 释放时回收到池，支持块合并减少碎片 - 分层架构：&lt;1MB用桶缓存，≥1MB用块分配器</p> <h3 id=_22><strong>实施结果</strong><a class=headerlink href=#_22 title="Permanent link">&para;</a></h3> <h4 id=_23><strong>整体性能对比</strong><a class=headerlink href=#_23 title="Permanent link">&para;</a></h4> <div class="language-text highlight"><span class=filename>Text Only</span><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>Phase 2 → Phase 3:
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>平均加速比: 0.97x → 1.41x (+45%提升)
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>中位数加速比: 0.88x → 0.81x (轻微下降)
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>最佳性能: 2.60x → 4.83x (新的性能峰值)
</span></code></pre></div> <h4 id=_24><strong>关键场景的重大突破</strong><a class=headerlink href=#_24 title="Permanent link">&para;</a></h4> <p><strong>大幅改善的场景:</strong> - Transformer训练: 0.05x → 1.89x (+3680%，从严重瓶颈到超越PyTorch) - 大内存分配: 1.29x → 3.92x (+204%，显著优于PyTorch) - 大尺寸重复分配: 从Phase 1的0.27x到Phase 3的2.31x</p> <p><strong>保持稳定的场景:</strong> - 小分配场景基本保持原有水平 - 推理服务等实用场景表现稳定</p> <p><strong>仍需改进的场景:</strong> - 梯度累积: 0.07x → 0.18x (有改善但仍较差) - 变化尺寸分配: 0.83x → 0.34x (受分层策略影响)</p> <h3 id=_25><strong>技术成就</strong><a class=headerlink href=#_25 title="Permanent link">&para;</a></h3> <p><strong>成功解决的核心问题:</strong> - 彻底消除了大分配场景的cudaMalloc系统调用开销 - 实现了真正的内存池复用机制 - 验证了块分配器架构的有效性</p> <p><strong>技术架构的成功:</strong> - 分层分配策略工作正常 - 1GB内存段的利用率良好 - Best-fit算法和块合并机制有效</p> <p><strong>局限性认知:</strong> - 小分配场景仍有改进空间 - 部分特殊场景(如梯度累积)需要进一步调优 - 相比成熟的PyTorch，在某些细分场景还有差距</p> <h3 id=phase-3><strong>Phase 3评估</strong><a class=headerlink href=#phase-3 title="Permanent link">&para;</a></h3> <p>Block Allocator成功解决了最关键的大内存分配瓶颈，让Genesis在重要场景下达到甚至超越PyTorch的性能。虽然不是所有场景都完美，但已经从"严重落后"转变为"基本可用，某些场景领先"的状态。</p> <p>这为Genesis在实际深度学习任务中的应用奠定了坚实基础。</p> <h2 id=_26>优化历程总结<a class=headerlink href=#_26 title="Permanent link">&para;</a></h2> <p>从最初的"灾难性性能"(0.02x)到现在的"整体领先"(1.41x)，这次内存分配器优化取得了实质性突破：</p> <h3 id=_27><strong>三个阶段的渐进式改进</strong><a class=headerlink href=#_27 title="Permanent link">&para;</a></h3> <ul> <li><strong>Phase 1</strong>: 解决了最基本的内存复用问题，建立了优化基础</li> <li><strong>Phase 2</strong>: 提高了变化尺寸场景的缓存命中率，改善了中位数性能 </li> <li><strong>Phase 3</strong>: 彻底解决了大内存分配瓶颈，实现了质的飞跃</li> </ul> <h3 id=_28><strong>技术路线的正确性验证</strong><a class=headerlink href=#_28 title="Permanent link">&para;</a></h3> <p>通过系统性的基准测试和根因分析，我们准确识别了性能瓶颈并选择了正确的技术方案。每个阶段都有明确的目标和可衡量的成果。</p> <h3 id=_29><strong>实用价值</strong><a class=headerlink href=#_29 title="Permanent link">&para;</a></h3> <p>Genesis现在在大部分实际场景下都能提供可接受的内存分配性能，特别是在大规模模型训练这类关键场景下已经具备了竞争力。</p> <p>当然，这只是内存管理优化的一个阶段性成果。未来还可以考虑更多优化方向，比如多流并发、NUMA感知、或者针对特定模型的专门优化等。</p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title="Last update"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime" title="August 13, 2025 08:54:09 UTC">2025-08-13 08:54:09</span> </span> <span class=md-source-file__fact> <span class=md-icon title=Created> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime" title="August 13, 2025 08:54:09 UTC">2025-08-13 08:54:09</span> </span> </aside> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> Back to top </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2025 Genesis Team </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/phonism/genesis target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </a> <a href=https://pypi.org/project/genesis-dl/ target=_blank rel=noopener title=pypi.org class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <div class=md-consent data-md-component=consent id=__consent hidden> <div class=md-consent__overlay></div> <aside class=md-consent__inner> <form class="md-consent__form md-grid md-typeset" name=consent> <h4>Cookie consent</h4> <p>We use cookies to recognize your repeated visits and preferences, as well as to measure the effectiveness of our documentation and whether users find what they're searching for. With your consent, you're helping us to make our documentation better.</p> <input class=md-toggle type=checkbox id=__settings> <div class=md-consent__settings> <ul class=task-list> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=analytics checked> <span class=task-list-indicator></span> Google Analytics </label> </li> <li class=task-list-item> <label class=task-list-control> <input type=checkbox name=github checked> <span class=task-list-indicator></span> GitHub </label> </li> </ul> </div> <div class=md-consent__controls> <button class="md-button md-button--primary">Accept</button> <label class=md-button for=__settings>Manage settings</label> </div> </form> </aside> </div> <script>var consent=__md_get("__consent");if(consent)for(var input of document.forms.consent.elements)input.name&&(input.checked=consent[input.name]||!1);else"file:"!==location.protocol&&setTimeout((function(){document.querySelector("[data-md-component=consent]").hidden=!1}),250);var form=document.forms.consent;for(var action of["submit","reset"])form.addEventListener(action,(function(e){if(e.preventDefault(),"reset"===e.type)for(var n of document.forms.consent.elements)n.name&&(n.checked=!1);__md_set("__consent",Object.fromEntries(Array.from(new FormData(form).keys()).map((function(e){return[e,!0]})))),location.hash="",location.reload()}))</script> <script id=__config type=application/json>{"base": "../..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.path", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow", "toc.integrate"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script> <script src=../../assets/javascripts/bundle.50899def.min.js></script> <script src=../../javascripts/mathjax.js></script> <script src=../../javascripts/i18n.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> </body> </html>